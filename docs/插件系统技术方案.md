# URLDB æ’ä»¶ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [äº‹ä»¶ç³»ç»Ÿ](#äº‹ä»¶ç³»ç»Ÿ)
5. [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
6. [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [æ‰©å±•æ¥å£](#æ‰©å±•æ¥å£)

---

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

### è®¾è®¡ç›®æ ‡
URLDBæ’ä»¶ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäºäº‹ä»¶é©±åŠ¨æ¶æ„çš„æ‰©å±•ç³»ç»Ÿï¼Œå€Ÿé‰´äº†PocketBaseçš„è®¾è®¡ç†å¿µï¼Œæ—¨åœ¨ä¸ºURLDBåº”ç”¨æä¾›çµæ´»ã€å®‰å…¨ã€é«˜æ€§èƒ½çš„æ’ä»¶åŒ–èƒ½åŠ›ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **äº‹ä»¶é©±åŠ¨æ¶æ„** - åŸºäºHookæœºåˆ¶çš„å¼‚æ­¥äº‹ä»¶å¤„ç†
- âœ… **ç±»å‹å®‰å…¨** - å®Œæ•´çš„Goç±»å‹ç³»ç»Ÿå’Œæ³›å‹æ”¯æŒ
- âœ… **ä¼˜å…ˆçº§æ§åˆ¶** - æ’ä»¶æ‰§è¡Œé¡ºåºå¯é…ç½®
- âœ… **çƒ­é‡è½½æ”¯æŒ** - å¼€å‘æ¨¡å¼ä¸‹å®æ—¶æ’ä»¶æ›´æ–°
- âœ… **CLIå·¥å…·é“¾** - å®Œæ•´çš„æ’ä»¶ç®¡ç†å‘½ä»¤è¡Œå·¥å…·
- âœ… **é”™è¯¯éš”ç¦»** - å•ä¸ªæ’ä»¶é”™è¯¯ä¸å½±å“ä¸»ç³»ç»Ÿ
- âœ… **èµ„æºç®¡ç†** - è‡ªåŠ¨èµ„æºæ¸…ç†å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    A[URLDBä¸»åº”ç”¨] --> B[æ’ä»¶é›†æˆå±‚]
    B --> C[äº‹ä»¶åˆ†å‘å™¨]
    C --> D[Hookç®¡ç†å™¨]
    D --> E[æ’ä»¶æ‰§è¡Œå™¨]
    E --> F[JavaScriptè¿è¡Œæ—¶]
    E --> G[æ•°æ®åº“è¿ç§»å™¨]

    H[CLIå·¥å…·] --> I[æ’ä»¶ç®¡ç†å™¨]
    I --> J[æ¨¡æ¿ç”Ÿæˆå™¨]
    I --> K[éªŒè¯å™¨]
    I --> L[ç»Ÿè®¡å™¨]

    M[é…ç½®ç³»ç»Ÿ] --> N[ç¯å¢ƒå˜é‡]
    M --> O[é…ç½®éªŒè¯]
    M --> P[ç›®å½•ç®¡ç†]
```

### æ ¸å¿ƒå±‚æ¬¡

1. **åº”ç”¨å±‚ (Application Layer)**
   - URLDBä¸»ä¸šåŠ¡é€»è¾‘
   - HTTPè·¯ç”±å’ŒAPIå¤„ç†
   - æ•°æ®åº“æ“ä½œ

2. **æ’ä»¶é›†æˆå±‚ (Plugin Integration Layer)**
   - äº‹ä»¶è§¦å‘å’Œåˆ†å‘
   - æ’ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - é”™è¯¯å¤„ç†å’Œæ—¥å¿—

3. **æ’ä»¶æ‰§è¡Œå±‚ (Plugin Execution Layer)**
   - Hookå¤„ç†å™¨
   - JavaScriptè¿è¡Œæ—¶
   - æ•°æ®åº“è¿ç§»å¼•æ“

4. **å·¥å…·æ”¯æŒå±‚ (Tooling Layer)**
   - CLIç®¡ç†å·¥å…·
   - æ¨¡æ¿ç”Ÿæˆå™¨
   - é…ç½®ç®¡ç†ç³»ç»Ÿ

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. Hookç³»ç»Ÿ

#### æ ¸å¿ƒæ¥å£
```go
// Hook é€šç”¨æ¥å£
type Hook[T any] interface {
    Bind(handler *Handler[T]) string
    BindFunc(fn func(e T) error) string
    Unbind(id string) error
    Trigger(e T) error
}

// äº‹ä»¶å¤„ç†å™¨
type Handler[T any] struct {
    ID     string
    Func   func(e T) error
    Priority int
}

// äº‹ä»¶æ•°æ®æ¥å£
type Resolver interface {
    Next() error
}
```

#### å®ç°ç‰¹æ€§
- **æ³›å‹æ”¯æŒ** - ç±»å‹å®‰å…¨çš„äº‹ä»¶å¤„ç†
- **ä¼˜å…ˆçº§æ’åº** - é«˜ä¼˜å…ˆçº§å¤„ç†å™¨ä¼˜å…ˆæ‰§è¡Œ
- **é”™è¯¯é“¾ä¼ æ’­** - æ”¯æŒè´£ä»»é“¾æ¨¡å¼
- **å¹¶å‘å®‰å…¨** - çº¿ç¨‹å®‰å…¨çš„Hookæ“ä½œ

### 2. äº‹ä»¶ç³»ç»Ÿ

#### å†…ç½®äº‹ä»¶ç±»å‹

```go
// URLç›¸å…³äº‹ä»¶
type URLEvent struct {
    *entity.Resource
    data map[string]interface{}
    resolver.Resolver
}

// ç”¨æˆ·ç›¸å…³äº‹ä»¶
type UserEvent struct {
    *entity.User
    data map[string]interface{}
    resolver.Resolver
}

// APIè¯·æ±‚äº‹ä»¶
type APIRequestEvent struct {
    Method  string
    Path    string
    Headers map[string]string
    Body    interface{}
    resolver.Resolver
}
```

#### äº‹ä»¶ç”Ÿå‘½å‘¨æœŸ
1. **äº‹ä»¶åˆ›å»º** - æ„å»ºäº‹ä»¶æ•°æ®ç»“æ„
2. **é¢„å¤„ç†** - æ•°æ®éªŒè¯å’Œè½¬æ¢
3. **Hookè§¦å‘** - æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œå¤„ç†å™¨
4. **åå¤„ç†** - æ¸…ç†å’Œæ—¥å¿—è®°å½•
5. **ç»“æœè¿”å›** - å¤„ç†ç»“æœèšåˆ

### 3. JavaScriptè¿è¡Œæ—¶

#### è¿è¡Œæ—¶æ¶æ„
```go
type JSVM struct {
    vmPool    chan *goja.Runtime
    hooksDir  string
    migrationsDir string
    typesDir  string
    hotReload bool
    debug     bool
}
```

#### æ ¸å¿ƒåŠŸèƒ½
- **VMæ± ç®¡ç†** - å¤ç”¨JavaScriptè¿è¡Œæ—¶å®ä¾‹
- **çƒ­é‡è½½** - æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°åŠ è½½
- **ç±»å‹ç»‘å®š** - Goå¯¹è±¡åˆ°JavaScriptçš„ç±»å‹æ˜ å°„
- **å®‰å…¨æ²™ç®±** - é™åˆ¶JavaScriptä»£ç è®¿é—®æƒé™

---

## ğŸ“¡ äº‹ä»¶ç³»ç»Ÿè¯¦è§£

### äº‹ä»¶æ³¨å†Œæœºåˆ¶

```go
// æ³¨å†ŒURLæ·»åŠ äº‹ä»¶é’©å­
app.OnURLAdd().BindFunc(func(e *URLEvent) error {
    // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
    if strings.Contains(e.URL, "example.com") {
        e.Category = "example"
    }
    return e.Next()
})
```

### å†…ç½®é’©å­åˆ—è¡¨

| é’©å­åç§° | è§¦å‘æ—¶æœº | äº‹ä»¶ç±»å‹ | ç”¨é€” |
|---------|---------|---------|------|
| `OnURLAdd` | URLæ·»åŠ æ—¶ | `*URLEvent` | URLå¤„ç†ã€åˆ†ç±»ã€éªŒè¯ |
| `OnURLAccess` | URLè®¿é—®æ—¶ | `*URLAccessEvent` | è®¿é—®ç»Ÿè®¡ã€æƒé™æ£€æŸ¥ |
| `OnUserLogin` | ç”¨æˆ·ç™»å½•æ—¶ | `*UserEvent` | ç™»å½•éªŒè¯ã€æ—¥å¿—è®°å½• |
| `OnUserRegister` | ç”¨æˆ·æ³¨å†Œæ—¶ | `*UserEvent` | æ³¨å†ŒéªŒè¯ã€æ¬¢è¿æ¶ˆæ¯ |
| `OnAPIRequest` | APIè¯·æ±‚æ—¶ | `*APIRequestEvent` | è¯·æ±‚æ‹¦æˆªã€é™æµæ§åˆ¶ |
| `OnDatabaseMigration` | æ•°æ®åº“è¿ç§»æ—¶ | `*MigrationEvent` | æ•°æ®è½¬æ¢ã€éªŒè¯ |

### äº‹ä»¶æ•°æ®ä¼ é€’

```go
// äº‹ä»¶æ•°æ®ç»“æ„
type URLEvent struct {
    *entity.Resource           // åŸå§‹URLæ•°æ®
    data        map[string]interface{} // æ‰©å±•æ•°æ®
    resolver.Resolver         // ä¸‹ä¸€æ­¥å¤„ç†å™¨
}

// æ‰©å±•æ•°æ®è®¿é—®
func (e *URLEvent) SetData(key string, value interface{}) {
    if e.data == nil {
        e.data = make(map[string]interface{})
    }
    e.data[key] = value
}

func (e *URLEvent) GetData(key string) interface{} {
    return e.data[key]
}
```

---

## âš™ï¸ é…ç½®ç®¡ç†

### é…ç½®ç»“æ„

```go
type PluginConfig struct {
    Enabled      bool   `json:"enabled" env:"PLUGIN_ENABLED"`
    HotReload    bool   `json:"hot_reload" env:"PLUGIN_HOT_RELOAD"`
    HooksDir     string `json:"hooks_dir" env:"PLUGIN_HOOKS_DIR"`
    MigrationsDir string `json:"migrations_dir" env:"PLUGIN_MIGRATIONS_DIR"`
    TypesDir     string `json:"types_dir" env:"PLUGIN_TYPES_DIR"`
    VMPoolSize   int    `json:"vm_pool_size" env:"PLUGIN_VM_POOL_SIZE"`
    Debug        bool   `json:"debug" env:"PLUGIN_DEBUG"`
}
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶é…ç½®
PLUGIN_ENABLED=true
PLUGIN_HOT_RELOAD=true
PLUGIN_HOOKS_DIR=./hooks
PLUGIN_MIGRATIONS_DIR=./migrations
PLUGIN_TYPES_DIR=./pb_data
PLUGIN_VM_POOL_SIZE=10
PLUGIN_DEBUG=false
```

### é…ç½®éªŒè¯

```go
func ValidatePluginConfig(config *PluginConfig) error {
    if config.HooksDir == "" {
        return fmt.Errorf("Hooks directory cannot be empty")
    }
    if config.VMPoolSize <= 0 || config.VMPoolSize > 100 {
        return fmt.Errorf("VM pool size must be between 1 and 100")
    }
    return nil
}
```

---

## ğŸ”’ å®‰å…¨æœºåˆ¶

### 1. ä»£ç éš”ç¦»

- **è¿›ç¨‹éš”ç¦»** - æ’ä»¶è¿è¡Œåœ¨ç‹¬ç«‹çš„JavaScript VMä¸­
- **å†…å­˜é™åˆ¶** - é™åˆ¶æ’ä»¶å¯ä½¿ç”¨çš„å†…å­˜å¤§å°
- **æ‰§è¡Œè¶…æ—¶** - é˜²æ­¢æ— é™å¾ªç¯å’Œé•¿æ—¶é—´æ‰§è¡Œ
- **APIé™åˆ¶** - é™åˆ¶æ’ä»¶å¯è®¿é—®çš„ç³»ç»ŸAPI

### 2. æƒé™æ§åˆ¶

```go
// JavaScript APIæƒé™ç™½åå•
var allowedAPIs = map[string]bool{
    "console.log":     true,
    "console.error":   true,
    "console.warn":    true,
    "db.query":        true,
    "db.execute":      true,
    "http.get":        false,  // ç¦æ­¢ç½‘ç»œè¯·æ±‚
    "fs.read":         false,  // ç¦æ­¢æ–‡ä»¶ç³»ç»Ÿè®¿é—®
}
```

### 3. è¾“å…¥éªŒè¯

- **å‚æ•°ç±»å‹æ£€æŸ¥** - ä¸¥æ ¼çš„ç±»å‹éªŒè¯
- **SQLæ³¨å…¥é˜²æŠ¤** - å‚æ•°åŒ–æŸ¥è¯¢
- **XSSé˜²æŠ¤** - è¾“å‡ºå†…å®¹è½¬ä¹‰
- **æ–‡ä»¶ç±»å‹éªŒè¯** - ä¸Šä¼ æ–‡ä»¶ç±»å‹é™åˆ¶

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. VMæ± ç®¡ç†

```go
// VMæ± å®ç°
type VMPool struct {
    pool chan *goja.Runtime
    maxSize int
    currentSize int
}

func (p *VMPool) Get() *goja.Runtime {
    select {
    case vm := <-p.pool:
        return vm
    default:
        return p.createNewVM()
    }
}

func (p *VMPool) Put(vm *goja.Runtime) {
    select {
    case p.pool <- vm:
    default:
        // æ± å·²æ»¡ï¼Œä¸¢å¼ƒVM
    }
}
```

### 2. ç¼“å­˜æœºåˆ¶

- **ç¼–è¯‘ç¼“å­˜** - JavaScriptä»£ç ç¼–è¯‘ç»“æœç¼“å­˜
- **æ¨¡æ¿ç¼“å­˜** - æ’ä»¶æ¨¡æ¿ç¼“å­˜
- **é…ç½®ç¼“å­˜** - æ’ä»¶é…ç½®å†…å­˜ç¼“å­˜
- **ç»“æœç¼“å­˜** - æ’ä»¶æ‰§è¡Œç»“æœç¼“å­˜

### 3. å¼‚æ­¥å¤„ç†

```go
// å¼‚æ­¥äº‹ä»¶å¤„ç†
func (h *Hook[T]) TriggerAsync(e T) {
    go func() {
        defer func() {
            if r := recover(); r != nil {
                log.Printf("Plugin execution panic: %v", r)
            }
        }()
        h.Trigger(e)
    }()
}
```

---

## ğŸ”Œ æ‰©å±•æ¥å£

### 1. è‡ªå®šä¹‰äº‹ä»¶ç±»å‹

```go
// å®šä¹‰è‡ªå®šä¹‰äº‹ä»¶
type CustomEvent struct {
    Name string
    Data map[string]interface{}
    resolver.Resolver
}

// æ³¨å†Œè‡ªå®šä¹‰é’©å­
app.RegisterHook("custom", func() *Hook[*CustomEvent] {
    return &Hook[*CustomEvent]{}
})

// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
app.TriggerCustom("custom_event", map[string]interface{}{
    "key": "value",
})
```

### 2. æ’ä»¶é€šä¿¡æ¥å£

```go
// æ’ä»¶é—´é€šä¿¡
type PluginBus interface {
    Publish(topic string, data interface{}) error
    Subscribe(topic string, handler func(data interface{})) error
    Unsubscribe(topic string, handlerID string) error
}

// å…¨å±€äº‹ä»¶æ€»çº¿
var GlobalBus PluginBus = NewEventBus()
```

### 3. æ•°æ®åº“æ‰©å±•

```go
// è‡ªå®šä¹‰æ•°æ®åº“æ“ä½œ
type DatabaseExtension interface {
    Query(sql string, args ...interface{}) (*sql.Rows, error)
    Execute(sql string, args ...interface{}) (sql.Result, error)
    Transaction(fn func(tx *sql.Tx) error) error
}

// æ’ä»¶ä¸­æ•°æ®åº“ä½¿ç”¨
app.OnDatabaseMigration().BindFunc(func(e *MigrationEvent) error {
    db := e.GetDatabase()
    return db.Execute(`
        CREATE TABLE IF NOT EXISTS plugin_data (
            id TEXT PRIMARY KEY,
            data JSON,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `)
})
```

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. æ’ä»¶ç»Ÿè®¡

```go
type PluginStats struct {
    TotalHooks       int                    `json:"total_hooks"`
    ActivePlugins    []string               `json:"active_plugins"`
    ExecutionTimes   map[string]time.Duration `json:"execution_times"`
    ErrorCounts      map[string]int          `json:"error_counts"`
    MemoryUsage      int64                  `json:"memory_usage"`
}
```

### 2. è°ƒè¯•å·¥å…·

```bash
# æŸ¥çœ‹æ’ä»¶ç»Ÿè®¡
./urldb plugin stats

# éªŒè¯æ’ä»¶è¯­æ³•
./urldb plugin validate hooks/my_plugin.pb.js

# åˆ—å‡ºæ‰€æœ‰æ’ä»¶
./urldb plugin list
```

### 3. æ—¥å¿—è®°å½•

```go
// æ’ä»¶æ‰§è¡Œæ—¥å¿—
type PluginLogger struct {
    level LogLevel
    output io.Writer
}

func (l *PluginLogger) LogExecution(pluginID string, duration time.Duration, err error) {
    if err != nil {
        l.Errorf("Plugin %s execution failed: %v (duration: %v)", pluginID, err, duration)
    } else {
        l.Infof("Plugin %s executed successfully (duration: %v)", pluginID, duration)
    }
}
```

---

## ğŸ”„ ç‰ˆæœ¬å…¼å®¹æ€§

### è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- **ä¸»ç‰ˆæœ¬å·** - ä¸å…¼å®¹çš„APIä¿®æ”¹
- **æ¬¡ç‰ˆæœ¬å·** - å‘ä¸‹å…¼å®¹çš„åŠŸèƒ½æ€§æ–°å¢
- **ä¿®è®¢å·** - å‘ä¸‹å…¼å®¹çš„é—®é¢˜ä¿®æ­£

### APIå…¼å®¹æ€§ä¿è¯
```go
// ç‰ˆæœ¬åŒ–APIæ¥å£
type PluginAPIv1 interface {
    ProcessURL(url string) error
}

type PluginAPIv2 interface {
    PluginAPIv1
    ProcessURLWithContext(ctx context.Context, url string) error
    ProcessBatch(urls []string) error
}
```

---

## ğŸ“š æœ€ä½³å®è·µ

### 1. æ’ä»¶å¼€å‘è§„èŒƒ
- ä½¿ç”¨TypeScriptè¿›è¡Œç±»å‹å®‰å…¨å¼€å‘
- éµå¾ªå‘½åçº¦å®šå’Œä»£ç é£æ ¼
- å®ç°é€‚å½“çš„é”™è¯¯å¤„ç†
- æä¾›å®Œæ•´çš„æ–‡æ¡£å’Œç¤ºä¾‹

### 2. æ€§èƒ½ä¼˜åŒ–å»ºè®®
- é¿å…åœ¨æ’ä»¶ä¸­è¿›è¡Œè€—æ—¶æ“ä½œ
- åˆç†ä½¿ç”¨ç¼“å­˜æœºåˆ¶
- åŠæ—¶é‡Šæ”¾èµ„æº
- ç›‘æ§æ’ä»¶æ‰§è¡Œæ€§èƒ½

### 3. å®‰å…¨å¼€å‘æŒ‡å—
- éªŒè¯æ‰€æœ‰è¾“å…¥æ•°æ®
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- é¿å…åŠ¨æ€ä»£ç æ‰§è¡Œ
- å®šæœŸæ›´æ–°ä¾èµ–åŒ…

---

è¿™ä¸ªæŠ€æœ¯æ–¹æ¡ˆä¸ºURLDBæ’ä»¶ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„è®¾è®¡å’Œå®ç°æŒ‡å¯¼ï¼Œç¡®ä¿ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å®‰å…¨æ€§å’Œé«˜æ€§èƒ½ã€‚