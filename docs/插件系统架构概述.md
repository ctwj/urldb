# URLDB 插件系统架构概述

## 概述

URLDB插件系统是一个基于JavaScript/Goja的可扩展架构，允许开发者通过钩子插件扩展系统功能。插件系统采用事件驱动架构，提供丰富的API接口供插件调用。

## 核心设计理念

### 1. 简洁性
- 专注于钩子插件模式，移除复杂的压缩包插件
- 简化插件开发流程
- 减少不必要的复杂性

### 2. 安全性
- JavaScript代码在安全沙箱中运行
- 限制文件系统和网络访问权限
- 参数化查询防止SQL注入

### 3. 可扩展性
- 事件驱动架构支持多种系统事件
- 丰富的API接口供插件使用
- 支持自定义路由和定时任务

## 架构组件

### 1. 插件注册器 (Plugin Register)
- 负责插件的加载和注册
- 管理插件生命周期
- 处理插件依赖关系

### 2. 事件分发器 (Event Dispatcher)
- 捕获系统事件（URL添加、用户登录等）
- 将事件分发给相应的插件
- 处理事件响应和回调

### 3. JavaScript运行时 (Goja Runtime)
- 提供JavaScript执行环境
- 实现Go与JavaScript的绑定
- 管理VM池以优化性能

### 4. API绑定层 (API Bindings)
- 提供数据库操作接口
- 提供文件系统访问接口
- 提供网络请求接口
- 提供安全函数接口

## 插件类型

### 钩子插件 (Hook Plugins)
- 文件名格式：`*.plugin.js`
- 存放位置：`plugin-system/hooks/`
- 功能：监听系统事件、添加自定义路由、执行定时任务

### 压缩包插件 (Package Plugins)
- 文件格式：ZIP压缩包
- 存放位置：`plugins/installed/{plugin_name}/hooks/`
- 结构要求：
  - `package.json` - 插件配置文件
  - `hooks/` - 钩子文件目录
  - `migrate/` (可选) - 数据库迁移文件目录
- 功能：完整的插件包，支持依赖管理和数据库迁移

## 插件生命周期

### 1. 加载阶段
```
插件文件 → 语法检查 → API绑定注入 → 事件监听器注册
```

### 2. 执行阶段
```
系统事件触发 → 事件分发 → 插件处理 → 结果返回
```

### 3. 更新阶段
```
文件修改 → 热重载检测 → 插件重新加载 → 保持状态
```

## API接口概览

### 事件监听
- `onURLAdd`: URL添加事件
- `onURLAccess`: URL访问事件
- `onUserLogin`: 用户登录事件
- `onReadyResourceAdd`: 待处理资源添加事件

### 数据库操作
- `db.find`: 查询数据
- `db.save`: 保存数据
- `db.update`: 更新数据
- `db.delete`: 删除数据
- `db.count`: 统计数据
- `db.raw`: 原始SQL查询

### 路由开发
- `routerAdd`: 添加自定义路由

### 定时任务
- `cronAdd`: 添加定时任务
- `cronRemove`: 移除定时任务

### 配置管理
- `getPluginConfig`: 获取插件配置
- `setPluginConfig`: 设置插件配置

### 安全函数
- `$security.md5`: MD5哈希
- `$security.sha256`: SHA256哈希
- `$security.randomString`: 随机字符串生成
- `$security.createJWT`: JWT创建
- `$security.parseJWT`: JWT解析

## 安全机制

### 1. 沙箱执行
- JavaScript代码在隔离环境中执行
- 限制对系统资源的直接访问

### 2. 权限控制
- API绑定提供受控的系统访问
- 文件系统访问限制在特定目录

### 3. 输入验证
- 所有外部输入经过验证
- 防止注入攻击

## 最佳实践

### 1. 性能优化
- 避免在事件处理器中执行耗时操作
- 合理使用定时任务
- 优化数据库查询

### 2. 错误处理
- 使用try-catch包装可能出错的代码
- 记录适当的错误日志
- 提供有意义的错误信息

### 3. 代码规范
- 使用有意义的变量名和函数名
- 添加适当的注释
- 遵循JavaScript编码规范

## 部署注意事项

### 目录结构
```
plugin-system/
├── hooks/          # 插件文件存放目录
│   ├── my_plugin.plugin.js
│   └── another_plugin.plugin.js
└── types/          # TypeScript类型定义
    └── types.d.ts
```

### 环境配置
- `PLUGIN_ENABLED`: 启用插件系统
- `PLUGIN_HOT_RELOAD`: 启用热重载
- `PLUGIN_VM_POOL_SIZE`: VM池大小