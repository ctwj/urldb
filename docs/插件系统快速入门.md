# URLDB 插件系统快速入门

## 简介

URLDB插件系统允许开发者通过JavaScript扩展系统功能。插件可以响应系统事件、添加自定义API、执行定时任务等。

## 创建第一个插件

### 1. 创建插件文件

在 `plugin-system/hooks/` 目录下创建一个新文件，例如 `hello_world.plugin.js`：

```javascript
/// <reference path="../pb_data/types.d.ts" />

/**
 * hello_world 钩子
 * 创建时间: 2026-01-05 10:00:00
 *
 * @name hello_world
 * @display_name Hello World插件
 * @author 开发者姓名
 * @description 我的第一个URLDB插件
 * @version 1.0.0
 */

// 监听URL添加事件
onURLAdd(function(event) {
    console.log("检测到新URL:", event.url.title);
    log("info", "Hello World插件处理了新的URL: " + event.url.title, "hello_world");
});

// 添加自定义API路由
routerAdd("GET", "/api/hello", (e) => {
    return e.json(200, {
        message: "Hello from my first plugin!",
        timestamp: new Date().toISOString()
    });
});

// 添加定时任务（每分钟执行）
cronAdd("hello_task", "*/1 * * * *", () => {
    log("info", "Hello World定时任务执行", "hello_world");
});
```

### 2. 插件配置（可选）

如果需要配置选项，可以在插件头部添加：

```javascript
/**
 * @config
 * @field {string} greeting_msg 问候语 "自定义问候消息" @default "Hello, World!"
 * @field {boolean} enable_logging 启用日志 "是否记录操作日志" @default true
 * @config
 */
```

然后在插件中使用配置：

```javascript
// 获取插件配置
const config = getPluginConfig("hello_world");
const greeting = config?.greeting_msg || "Hello, World!";

if (config?.enable_logging) {
    log("info", greeting, "hello_world");
}
```

## 核心功能概览

### 1. 系统事件监听

```javascript
// URL相关事件
onURLAdd(function(event) { /* URL添加时执行 */ });
onURLAccess(function(event) { /* URL访问时执行 */ });
onURLUpdate(function(event) { /* URL更新时执行 */ });
onURLDelete(function(event) { /* URL删除时执行 */ });

// 用户相关事件
onUserLogin(function(event) { /* 用户登录时执行 */ });
onUserRegister(function(event) { /* 用户注册时执行 */ });

// 待处理资源事件
onReadyResourceAdd(function(event) { /* 待处理资源添加时执行 */ });
```

### 2. 自定义路由

```javascript
// GET请求
routerAdd("GET", "/api/my-endpoint", (e) => {
    return e.json(200, { message: "Success" });
});

// POST请求
routerAdd("POST", "/api/my-endpoint", (e) => {
    const data = e.body;
    return e.json(200, { received: data });
});

// 带参数的路由
routerAdd("GET", "/api/items/:id", (e) => {
    const id = e.params.id;
    return e.json(200, { id: id });
});
```

### 3. 数据库操作

```javascript
// 查询
const resources = db.find("resources", { category: "tech" });
const count = db.count("resources", { deleted_at: null });

// 保存
const newResource = db.save("resources", {
    title: "新资源",
    url: "http://example.com"
});

// 更新
db.update("resources", resourceId, { title: "新标题" });

// 删除
db.delete("resources", resourceId);

// 原始SQL查询
const result = db.raw("SELECT * FROM resources WHERE category = $1", ["tech"]);
```

### 4. 定时任务

```javascript
// 每5分钟执行
cronAdd("my_task", "*/5 * * * *", () => {
    log("info", "定时任务执行", "my_plugin");
});

// 每小时执行
cronAdd("hourly_task", "0 * * * *", () => {
    // 小时任务逻辑
});

// 每天凌晨2点执行
cronAdd("daily_task", "0 2 * * *", () => {
    // 每日任务逻辑
});
```

### 5. 文件操作

```javascript
// 读写文件
const content = $filesystem.readFile("/path/to/file.txt");
$filesystem.writeFile("/path/to/file.txt", "Hello World");

// 检查文件
const exists = $filesystem.fileExists("/path/to/file.txt");
const size = $filesystem.fileSize("/path/to/file.txt");

// 临时目录
const tempDir = $os.tempDir();
```

### 6. 安全函数

```javascript
// 哈希运算
const hash = $security.sha256("string");

// 随机字符串
const randomStr = $security.randomString(32);

// JWT令牌
const token = $security.createJWT(payload, "secret", 3600);
const decoded = $security.parseJWT(token, "secret");
```

## 部署插件

### 部署钩子插件

1. 将插件文件放置在 `plugin-system/hooks/` 目录下
2. 确保文件名以 `.plugin.js` 结尾
3. 重启URLDB应用或等待热重载
4. 插件将自动注册并开始运行

### 部署压缩包插件

1. 创建ZIP格式的插件包，包含以下结构：
   ```
   my_plugin.zip
   ├── package.json
   ├── hooks/
   │   └── my_hook.plugin.js
   └── migrate/ (可选)
       ├── install.sql
       └── uninstall.sql
   ```

2. 使用以下方式安装插件：
   - **API方式**: `POST /api/plugins/install` 上传ZIP文件
   - **手动方式**: 将ZIP文件解压到 `plugins/installed/{plugin_name}/` 目录

3. 系统会自动处理插件安装和初始化

## 调试技巧

- 使用 `log()` 函数记录调试信息
- 检查应用日志获取插件错误信息
- 使用 `/api/plugins` API查看插件状态
- 通过管理界面启用/禁用插件进行测试

## 常见问题

1. **插件不加载**: 检查文件名是否以 `.plugin.js` 结尾
2. **路由冲突**: 确保路由路径唯一
3. **数据库错误**: 检查表名和字段名是否正确
4. **配置不生效**: 验证配置声明格式是否正确

## 安全提示

- 始终验证外部输入
- 使用参数化查询防止SQL注入
- 避免在事件处理器中执行耗时操作
- 合理使用日志级别，避免日志过多