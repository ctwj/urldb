# URLDB æ’ä»¶ç³»ç»Ÿä½¿ç”¨æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [CLIå·¥å…·ä½¿ç”¨](#cliå·¥å…·ä½¿ç”¨)
3. [æ’ä»¶é…ç½®](#æ’ä»¶é…ç½®)
4. [äº‹ä»¶ç›‘å¬](#äº‹ä»¶ç›‘å¬)
5. [æ•°æ®åº“æ“ä½œ](#æ•°æ®åº“æ“ä½œ)
6. [APIæ‰©å±•](#apiæ‰©å±•)
7. [è°ƒè¯•å’Œç›‘æ§](#è°ƒè¯•å’Œç›‘æ§)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Go 1.24+
- Node.js 16+ (å¯é€‰ï¼Œç”¨äºTypeScriptå¼€å‘)
- PostgreSQL æ•°æ®åº“

### åŸºç¡€é…ç½®

1. **è®¾ç½®ç¯å¢ƒå˜é‡**
```bash
# .env æ–‡ä»¶
PLUGIN_ENABLED=true
PLUGIN_HOT_RELOAD=true
PLUGIN_HOOKS_DIR=./hooks
PLUGIN_MIGRATIONS_DIR=./migrations
PLUGIN_TYPES_DIR=./pb_data
PLUGIN_VM_POOL_SIZE=10
PLUGIN_DEBUG=false
```

2. **åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶**
```bash
# åˆ›å»ºé’©å­æ’ä»¶
./urldb plugin create my_first_hook hook

# åˆ›å»ºè¿ç§»æ’ä»¶
./urldb plugin create add_custom_table migration
```

3. **å¯åŠ¨åº”ç”¨**
```bash
# ç¼–è¯‘å¹¶å¯åŠ¨
go build -o urldb .
./urldb
```

---

## ğŸ› ï¸ CLIå·¥å…·ä½¿ç”¨

### å‘½ä»¤æ¦‚è§ˆ

```bash
# æŸ¥çœ‹æ‰€æœ‰æ’ä»¶å‘½ä»¤
./urldb plugin --help

# åˆ›å»ºæ’ä»¶æ¨¡æ¿
./urldb plugin create <name> <type>

# åˆ—å‡ºæ‰€æœ‰æ’ä»¶
./urldb plugin list

# éªŒè¯æ’ä»¶æ–‡ä»¶
./urldb plugin validate <file_path>

# æŸ¥çœ‹æ’ä»¶ç»Ÿè®¡
./urldb plugin stats
```

### è¯¦ç»†å‘½ä»¤è¯´æ˜

#### 1. åˆ›å»ºæ’ä»¶

```bash
# åˆ›å»ºé’©å­æ’ä»¶
./urldb plugin create url_analyzer hook
# è¾“å‡º: Plugin template created: hooks/url_analyzer.pb.js

# åˆ›å»ºæ•°æ®åº“è¿ç§»
./urldb plugin create add_user_preferences migration
# è¾“å‡º: Plugin template created: migrations/add_user_preferences.js
```

#### 2. æ’ä»¶ç®¡ç†

```bash
# åˆ—å‡ºæ‰€æœ‰æ’ä»¶
./urldb plugin list
# è¾“å‡º:
# === é’©å­æ–‡ä»¶ ===
#   - url_analyzer.pb.js (å¤§å°: 1024, ä¿®æ”¹æ—¶é—´: 2024-12-24 22:30:00)
#   - notification_hook.pb.js (å¤§å°: 2048, ä¿®æ”¹æ—¶é—´: 2024-12-24 22:25:00)
# === è¿ç§»æ–‡ä»¶ ===
#   - add_user_preferences.js (å¤§å°: 512, ä¿®æ”¹æ—¶é—´: 2024-12-24 22:28:00)

# éªŒè¯æ’ä»¶è¯­æ³•
./urldb plugin validate hooks/url_analyzer.pb.js
# è¾“å‡º: Plugin file validation passed: hooks/url_analyzer.pb.js
# è¾“å‡º: æ’ä»¶éªŒè¯é€šè¿‡: hooks/url_analyzer.pb.js
```

#### 3. ç»Ÿè®¡ä¿¡æ¯

```bash
./urldb plugin stats
# è¾“å‡º:
# === æ’ä»¶ç³»ç»Ÿç»Ÿè®¡ ===
# é’©å­æ–‡ä»¶æ•°é‡: 2
# è¿ç§»æ–‡ä»¶æ•°é‡: 1
# ç±»å‹æ–‡ä»¶å­˜åœ¨: true
# æœ€åæ›´æ–°æ—¶é—´: 2024-12-24 22:30:15
```

---

## âš™ï¸ æ’ä»¶é…ç½®

### å…¨å±€é…ç½®

åœ¨åº”ç”¨å¯åŠ¨æ—¶ï¼Œæ’ä»¶ç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½é…ç½®ï¼š

```go
// main.go ä¸­çš„é…ç½®åŠ è½½
pluginConfig := LoadPluginConfig()
if pluginConfig.Enabled {
    // éªŒè¯é…ç½®
    if err := ValidatePluginConfig(pluginConfig); err != nil {
        utils.Error("æ’ä»¶é…ç½®éªŒè¯å¤±è´¥: %v", err)
    } else {
        // åˆå§‹åŒ–æ’ä»¶ç³»ç»Ÿ
        InitializePluginSystem(repoManager)
    }
}
```

### åŠ¨æ€é…ç½®

æ’ä»¶å¯ä»¥é€šè¿‡é…ç½®ç³»ç»Ÿè·å–é…ç½®å€¼ï¼š

```javascript
// hooks/config_example.pb.js
/// <reference path="../pb_data/types.d.ts" />

// è·å–é…ç½®å€¼
const enabled = app.config.getBool("plugin.analytics.enabled", false);
const apiKey = app.config.getString("plugin.analytics.api_key", "");
const batchSize = app.config.getInt("plugin.analytics.batch_size", 100);

// ç›‘å¬URLæ·»åŠ äº‹ä»¶
onURLAdd((e) => {
    if (!enabled) {
        return e.next();
    }

    // å¤„ç†é€»è¾‘
    console.log("Analytics enabled:", enabled);
    console.log("API Key:", apiKey);
    console.log("Batch size:", batchSize);

    return e.next();
});
```

---

## ğŸ¯ äº‹ä»¶ç›‘å¬

### å†…ç½®äº‹ä»¶ç±»å‹

#### 1. URLäº‹ä»¶

```javascript
// hooks/url_handler.pb.js
/// <reference path="../pb_data/types.d.ts" />

// URLæ·»åŠ äº‹ä»¶
onURLAdd((e) => {
    console.log("URLæ·»åŠ :", e.url.url);

    // è‡ªåŠ¨åˆ†ç±»
    if (e.url.url.includes("github.com")) {
        e.url.category = "development";
    } else if (e.url.url.includes("youtube.com")) {
        e.url.category = "video";
    }

    // æ·»åŠ æ ‡ç­¾
    if (!e.url.tags) {
        e.url.tags = [];
    }
    e.url.tags.push("auto-tagged");

    // è®°å½•æ—¥å¿—
    console.log("URLå·²åˆ†ç±»:", e.url.category);

    return e.next();
});

// URLè®¿é—®äº‹ä»¶
onURLAccess((e) => {
    console.log("URLè®¿é—®:", e.url.url, "ç”¨æˆ·:", e.user.username);

    // è®¿é—®ç»Ÿè®¡
    const stats = {
        url: e.url.url,
        userId: e.user.id,
        accessTime: new Date().toISOString(),
        userAgent: e.userAgent
    };

    // ä¿å­˜åˆ°æ•°æ®åº“
    app.db.execute(`
        INSERT INTO access_stats (url, user_id, access_time, user_agent)
        VALUES (?, ?, ?, ?)
    `, [stats.url, stats.userId, stats.accessTime, stats.userAgent]);

    return e.next();
});
```

#### 2. ç”¨æˆ·äº‹ä»¶

```javascript
// hooks/user_handler.pb.js
/// <reference path="../pb_data/types.d.ts" />

// ç”¨æˆ·ç™»å½•äº‹ä»¶
onUserLogin((e) => {
    console.log("ç”¨æˆ·ç™»å½•:", e.user.username);

    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
    e.user.lastLogin = new Date().toISOString();

    // ç™»å½•å¥–åŠ±æ£€æŸ¥
    const lastLogin = new Date(e.user.lastLogin || 0);
    const today = new Date();
    const daysDiff = Math.floor((today - lastLogin) / (1000 * 60 * 60 * 24));

    if (daysDiff >= 1) {
        // å‘é€æ¬¢è¿æ¶ˆæ¯
        app.mail.send({
            to: e.user.email,
            subject: "æ¬¢è¿å›æ¥ï¼",
            body: `æ‚¨å¥½ ${e.user.username}ï¼Œæ¬¢è¿å›æ¥ä½¿ç”¨URLDBï¼`
        });
    }

    return e.next();
});

// ç”¨æˆ·æ³¨å†Œäº‹ä»¶
onUserRegister((e) => {
    console.log("æ–°ç”¨æˆ·æ³¨å†Œ:", e.user.username);

    // è®¾ç½®é»˜è®¤å€¼
    e.user.isActive = true;
    e.user.role = "user";

    // å‘é€æ¬¢è¿é‚®ä»¶
    app.mail.send({
        to: e.user.email,
        subject: "æ¬¢è¿æ³¨å†ŒURLDB",
        body: `æ¬¢è¿æ‚¨æ³¨å†ŒURLDBï¼Œ${e.user.username}ï¼`
    });

    // åˆ›å»ºç”¨æˆ·é…ç½®
    app.db.execute(`
        INSERT INTO user_preferences (user_id, theme, language)
        VALUES (?, ?, ?)
    `, [e.user.id, "light", "zh-CN"]);

    return e.next();
});
```

#### 3. APIè¯·æ±‚äº‹ä»¶

```javascript
// hooks/api_handler.pb.js
/// <reference path="../pb_data/types.d.ts" />

// APIè¯·æ±‚æ‹¦æˆª
onAPIRequest((e) => {
    console.log("APIè¯·æ±‚:", e.method, e.path);

    // è¯·æ±‚æ—¥å¿—
    const log = {
        method: e.method,
        path: e.path,
        userAgent: e.headers["user-agent"],
        ip: e.headers["x-forwarded-for"] || e.headers["x-real-ip"],
        timestamp: new Date().toISOString()
    };

    // ä¿å­˜è®¿é—®æ—¥å¿—
    app.db.execute(`
        INSERT INTO api_logs (method, path, user_agent, ip, timestamp)
        VALUES (?, ?, ?, ?, ?)
    `, [log.method, log.path, log.userAgent, log.ip, log.timestamp]);

    // é™æµæ£€æŸ¥
    if (e.path.startsWith("/api/")) {
        const clientId = e.headers["x-client-id"] || "anonymous";
        const count = app.db.queryOne(`
            SELECT COUNT(*) as count FROM api_requests
            WHERE client_id = ? AND created_at > datetime('now', '-1 minute')
        `, [clientId]).count;

        if (count > 100) {
            return e.json(429, {
                error: "Too Many Requests",
                message: "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"
            });
        }

        // è®°å½•è¯·æ±‚
        app.db.execute(`
            INSERT INTO api_requests (client_id, path, method, created_at)
            VALUES (?, ?, ?, datetime('now'))
        `, [clientId, e.path, e.method]);
    }

    return e.next();
});
```

### è‡ªå®šä¹‰äº‹ä»¶

```javascript
// hooks/custom_events.pb.js
/// <reference path="../pb_data/types.d.ts" />

// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶
onCustomEvent("user_level_up", (e) => {
    console.log("ç”¨æˆ·å‡çº§:", e.data.userId, "ç­‰çº§:", e.data.newLevel);

    // å‘é€å‡çº§é€šçŸ¥
    const user = app.db.queryOne(`
        SELECT * FROM users WHERE id = ?
    `, [e.data.userId]);

    if (user) {
        app.mail.send({
            to: user.email,
            subject: "æ­å–œå‡çº§ï¼",
            body: `æ­å–œæ‚¨å‡çº§åˆ°ç­‰çº§ ${e.data.newLevel}ï¼`
        });
    }

    return e.next();
});

// è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
function triggerLevelUp(userId, newLevel) {
    app.triggerCustom("user_level_up", {
        userId: userId,
        newLevel: newLevel,
        timestamp: new Date().toISOString()
    });
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ“ä½œ

### åŸºæœ¬æŸ¥è¯¢

```javascript
// hooks/db_operations.pb.js
/// <reference path="../pb_data/types.d.ts" />

onURLAdd((e) => {
    // æŸ¥è¯¢ç°æœ‰æ•°æ®
    const existing = app.db.queryOne(`
        SELECT * FROM urls WHERE url = ?
    `, [e.url.url]);

    if (existing) {
        console.log("URLå·²å­˜åœ¨:", existing.id);
        return e.next();
    }

    // æ’å…¥æ–°æ•°æ®
    const result = app.db.execute(`
        INSERT INTO urls (url, title, category, tags, created_at)
        VALUES (?, ?, ?, ?, datetime('now'))
    `, [
        e.url.url,
        e.url.title || "",
        e.url.category || "uncategorized",
        JSON.stringify(e.url.tags || [])
    ]);

    console.log("URLå·²ä¿å­˜:", result.lastInsertRowid);

    // æ›´æ–°ç»Ÿè®¡
    app.db.execute(`
        INSERT INTO url_stats (date, count)
        VALUES (date('now'), 1)
        ON CONFLICT(date) DO UPDATE SET
        count = count + 1
    `);

    return e.next();
});
```

### äº‹åŠ¡å¤„ç†

```javascript
// hooks/transaction_example.pb.js
/// <reference path="../pb_data/types.d.ts" />

onUserRegister((e) => {
    // ä½¿ç”¨äº‹åŠ¡å¤„ç†å¤šä¸ªæ“ä½œ
    const result = app.db.transaction((tx) => {
        // åˆ›å»ºç”¨æˆ·è®°å½•
        const userResult = tx.execute(`
            INSERT INTO users (username, email, created_at)
            VALUES (?, ?, datetime('now'))
        `, [e.user.username, e.user.email]);

        const userId = userResult.lastInsertRowid;

        // åˆ›å»ºç”¨æˆ·é…ç½®
        tx.execute(`
            INSERT INTO user_preferences (user_id, theme, notifications)
            VALUES (?, ?, ?)
        `, [userId, "light", true]);

        // åˆ›å»ºç”¨æˆ·ç»Ÿè®¡
        tx.execute(`
            INSERT INTO user_stats (user_id, urls_count, created_at)
            VALUES (?, 0, datetime('now'))
        `, [userId]);

        // å‘é€æ¬¢è¿æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—
        tx.execute(`
            INSERT INTO message_queue (type, data, created_at)
            VALUES (?, ?, datetime('now'))
        `, ["welcome_email", JSON.stringify({
            userId: userId,
            email: e.user.email
        })]);

        return userId;
    });

    if (result.success) {
        console.log("ç”¨æˆ·æ³¨å†ŒæˆåŠŸ:", result.result);
        e.user.id = result.result;
    } else {
        console.error("ç”¨æˆ·æ³¨å†Œå¤±è´¥:", result.error);
        return e.json(500, { error: "æ³¨å†Œå¤±è´¥" });
    }

    return e.next();
});
```

### å¤æ‚æŸ¥è¯¢

```javascript
// hooks/advanced_queries.pb.js
/// <reference path="../pb_data/types.d.ts" />

// å®šæœŸç»Ÿè®¡ä»»åŠ¡
cronAdd("generate_daily_stats", "0 1 * * *", () => {
    console.log("ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡");

    // URLç»Ÿè®¡
    const urlStats = app.db.query(`
        SELECT
            category,
            COUNT(*) as count,
            DATE(created_at) as date
        FROM urls
        WHERE created_at >= date('now', '-1 day')
        GROUP BY category, DATE(created_at)
        ORDER BY count DESC
    `);

    // ç”¨æˆ·æ´»è·ƒåº¦ç»Ÿè®¡
    const userStats = app.db.query(`
        SELECT
            COUNT(DISTINCT user_id) as active_users,
            DATE(created_at) as date
        FROM access_stats
        WHERE created_at >= date('now', '-1 day')
        GROUP BY DATE(created_at)
    `);

    // ä¿å­˜ç»Ÿè®¡ç»“æœ
    app.db.transaction((tx) => {
        // ä¿å­˜URLç»Ÿè®¡
        urlStats.forEach(stat => {
            tx.execute(`
                INSERT INTO daily_url_stats (date, category, count)
                VALUES (?, ?, ?)
                ON CONFLICT(date, category) DO UPDATE SET
                count = excluded.count
            `, [stat.date, stat.category, stat.count]);
        });

        // ä¿å­˜ç”¨æˆ·ç»Ÿè®¡
        userStats.forEach(stat => {
            tx.execute(`
                INSERT INTO daily_user_stats (date, active_users)
                VALUES (?, ?)
                ON CONFLICT(date) DO UPDATE SET
                active_users = excluded.active_users
            `, [stat.date, stat.active_users]);
        });
    });

    console.log("æ¯æ—¥ç»Ÿè®¡ç”Ÿæˆå®Œæˆ");
});
```

---

## ğŸ”Œ APIæ‰©å±•

### è‡ªå®šä¹‰è·¯ç”±

```javascript
// hooks/custom_routes.pb.js
/// <reference path="../pb_data/types.d.ts" />

// GET /api/plugins/stats
routerAdd("GET", "/api/plugins/stats", (e) => {
    const stats = {
        totalUrls: app.db.queryOne("SELECT COUNT(*) as count FROM urls").count,
        totalUsers: app.db.queryOne("SELECT COUNT(*) as count FROM users").count,
        todayAccess: app.db.queryOne(`
            SELECT COUNT(*) as count FROM access_stats
            WHERE DATE(created_at) = DATE('now')
        `).count
    };

    return e.json(200, {
        success: true,
        data: stats,
        timestamp: new Date().toISOString()
    });
});

// POST /api/plugins/analyze-url
routerAdd("POST", "/api/plugins/analyze-url", (e) => {
    const { url } = e.body;

    if (!url) {
        return e.json(400, {
            error: "URL is required"
        });
    }

    // URLåˆ†æé€»è¾‘
    const analysis = {
        url: url,
        domain: new URL(url).hostname,
        category: "unknown",
        tags: [],
        safety: "safe"
    };

    // åŸŸååˆ†ç±»
    if (analysis.domain.includes("github")) {
        analysis.category = "development";
        analysis.tags.push("code", "repository");
    } else if (analysis.domain.includes("youtube")) {
        analysis.category = "video";
        analysis.tags.push("media", "entertainment");
    }

    // å®‰å…¨æ£€æŸ¥
    const blockedDomains = app.db.query(`
        SELECT domain FROM blocked_domains
    `).map(row => row.domain);

    if (blockedDomains.includes(analysis.domain)) {
        analysis.safety = "blocked";
    }

    return e.json(200, {
        success: true,
        data: analysis
    });
});

// GET /api/plugins/user/:id/activity
routerAdd("GET", "/api/plugins/user/:id/activity", (e) => {
    const userId = e.pathParams.id;

    const activities = app.db.query(`
        SELECT
            ua.type,
            ua.data,
            ua.created_at
        FROM user_activities ua
        WHERE ua.user_id = ?
        ORDER BY ua.created_at DESC
        LIMIT 50
    `, [userId]);

    return e.json(200, {
        success: true,
        data: activities.map(activity => ({
            ...activity,
            data: JSON.parse(activity.data)
        }))
    });
});
```

### ä¸­é—´ä»¶

```javascript
// hooks/middleware_example.pb.js
/// <reference path="../pb_data/types.d.ts" />

// APIè®¤è¯ä¸­é—´ä»¶
routerAdd("GET", "/api/plugins/protected/*", (e) => {
    const token = e.headers["authorization"];

    if (!token) {
        return e.json(401, {
            error: "Authorization required"
        });
    }

    // éªŒè¯token
    const user = app.db.queryOne(`
        SELECT * FROM users WHERE auth_token = ?
    `, [token]);

    if (!user) {
        return e.json(401, {
            error: "Invalid token"
        });
    }

    // å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
    e.user = user;

    return e.next();
}, { priority: 100 }); // é«˜ä¼˜å…ˆçº§ï¼Œå…ˆæ‰§è¡Œ

// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
routerAdd("*", "/api/*", (e) => {
    const startTime = Date.now();

    // ç»§ç»­å¤„ç†è¯·æ±‚
    e.next().then(() => {
        const duration = Date.now() - startTime;

        console.log(`APIè¯·æ±‚: ${e.method} ${e.path} - ${e.statusCode} (${duration}ms)`);

        // ä¿å­˜è¯·æ±‚æ—¥å¿—
        app.db.execute(`
            INSERT INTO api_logs (method, path, status_code, duration, created_at)
            VALUES (?, ?, ?, ?, datetime('now'))
        `, [e.method, e.path, e.statusCode, duration]);
    });
});
```

---

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### è°ƒè¯•æ¨¡å¼

```javascript
// hooks/debug_example.pb.js
/// <reference path="../pb_data/types.d.ts" />

// å¼€å‘ç¯å¢ƒè°ƒè¯•
onURLAdd((e) => {
    // è°ƒè¯•æ¨¡å¼æ£€æŸ¥
    if (app.config.getBool("debug", false)) {
        console.log("=== DEBUG: URL Add Event ===");
        console.log("URL:", e.url.url);
        console.log("Title:", e.url.title);
        console.log("Category:", e.url.category);
        console.log("Tags:", e.url.tags);
        console.log("User:", e.user?.username || "anonymous");
        console.log("Timestamp:", new Date().toISOString());
        console.log("==============================");
    }

    // æ€§èƒ½ç›‘æ§
    const startTime = Date.now();

    // æ‰§è¡Œå¤„ç†é€»è¾‘
    try {
        // ä½ çš„å¤„ç†ä»£ç 
        processUrl(e.url);
    } catch (error) {
        console.error("URLå¤„ç†å¤±è´¥:", error);

        // é”™è¯¯ç»Ÿè®¡
        app.db.execute(`
            INSERT INTO error_logs (plugin, error_type, error_message, created_at)
            VALUES (?, ?, ?, datetime('now'))
        `, ["url_processor", "process_error", error.message]);
    }

    const duration = Date.now() - startTime;

    // æ€§èƒ½æ—¥å¿—
    if (duration > 1000) {
        console.warn("URLå¤„ç†è€—æ—¶è¿‡é•¿:", duration + "ms");
    }

    return e.next();
});
```

### å¥åº·æ£€æŸ¥

```javascript
// hooks/health_check.pb.js
/// <reference path="../pb_data/types.d.ts" />

// å¥åº·æ£€æŸ¥è·¯ç”±
routerAdd("GET", "/api/plugins/health", (e) => {
    const health = {
        status: "healthy",
        timestamp: new Date().toISOString(),
        checks: {}
    };

    // æ•°æ®åº“è¿æ¥æ£€æŸ¥
    try {
        const result = app.db.queryOne("SELECT 1 as test");
        health.checks.database = {
            status: "ok",
            response_time: result.test ? "fast" : "slow"
        };
    } catch (error) {
        health.checks.database = {
            status: "error",
            error: error.message
        };
        health.status = "unhealthy";
    }

    // æ’ä»¶çŠ¶æ€æ£€æŸ¥
    try {
        const pluginCount = app.db.queryOne("SELECT COUNT(*) as count FROM plugins").count;
        health.checks.plugins = {
            status: "ok",
            count: pluginCount
        };
    } catch (error) {
        health.checks.plugins = {
            status: "error",
            error: error.message
        };
    }

    // å†…å­˜ä½¿ç”¨æ£€æŸ¥
    const memUsage = process.memoryUsage();
    health.checks.memory = {
        status: "ok",
        rss: Math.round(memUsage.rss / 1024 / 1024) + "MB",
        heap_used: Math.round(memUsage.heapUsed / 1024 / 1024) + "MB",
        heap_total: Math.round(memUsage.heapTotal / 1024 / 1024) + "MB"
    };

    const statusCode = health.status === "healthy" ? 200 : 503;
    return e.json(statusCode, health);
});
```

### é”™è¯¯å¤„ç†

```javascript
// hooks/error_handling.pb.js
/// <reference path="../pb_data/types.d.ts" />

// å…¨å±€é”™è¯¯å¤„ç†
onError((e) => {
    console.error("æ’ä»¶é”™è¯¯:", e.error);
    console.error("æ’ä»¶ID:", e.pluginId);
    console.error("äº‹ä»¶ç±»å‹:", e.eventType);

    // é”™è¯¯åˆ†ç±»
    let errorType = "unknown";
    if (e.error.message.includes("timeout")) {
        errorType = "timeout";
    } else if (e.error.message.includes("database")) {
        errorType = "database";
    } else if (e.error.message.includes("network")) {
        errorType = "network";
    }

    // è®°å½•é”™è¯¯æ—¥å¿—
    app.db.execute(`
        INSERT INTO error_logs (
            plugin_id,
            event_type,
            error_type,
            error_message,
            stack_trace,
            created_at
        ) VALUES (?, ?, ?, ?, ?, datetime('now'))
    `, [
        e.pluginId,
        e.eventType,
        errorType,
        e.error.message,
        e.error.stack || ""
    ]);

    // é”™è¯¯é€šçŸ¥
    if (errorType === "database" || errorType === "network") {
        app.mail.send({
            to: "admin@example.com",
            subject: "URLDBæ’ä»¶é”™è¯¯è­¦æŠ¥",
            body: `æ’ä»¶ ${e.pluginId} å‘ç”Ÿ${errorType}é”™è¯¯: ${e.error.message}`
        });
    }

    return e.next();
});
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: æ’ä»¶ä¸ç”Ÿæ•ˆæ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. ç¡®è®¤æ’ä»¶ç³»ç»Ÿå·²å¯ç”¨
```bash
./urldb plugin stats
```

2. æ£€æŸ¥æ’ä»¶æ–‡ä»¶è¯­æ³•
```bash
./urldb plugin validate hooks/your_plugin.pb.js
```

3. æŸ¥çœ‹åº”ç”¨å¯åŠ¨æ—¥å¿—
```bash
./urldb 2>&1 | grep -i plugin
```

4. ç¡®è®¤äº‹ä»¶è§¦å‘æ¡ä»¶
```javascript
// æ·»åŠ è°ƒè¯•æ—¥å¿—
onURLAdd((e) => {
    console.log("URL Add event triggered:", e.url.url);
    return e.next();
});
```

### Q2: å¦‚ä½•è°ƒè¯•æ’ä»¶ï¼Ÿ

**A:** ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

1. å¯ç”¨è°ƒè¯•æ¨¡å¼
```bash
export PLUGIN_DEBUG=true
./urldb
```

2. ä½¿ç”¨console.logè¾“å‡º
```javascript
onURLAdd((e) => {
    console.log("Debug: URL:", e.url.url);
    console.log("Debug: User:", e.user?.username);
    console.log("Debug: Data:", JSON.stringify(e.data, null, 2));
    return e.next();
});
```

3. ä½¿ç”¨æ•°æ®åº“æ—¥å¿—è¡¨
```javascript
onURLAdd((e) => {
    app.db.execute(`
        INSERT INTO debug_logs (plugin, event, data, created_at)
        VALUES (?, ?, ?, datetime('now'))
    `, ["my_plugin", "url_add", JSON.stringify(e.url)]);

    return e.next();
});
```

### Q3: æ’ä»¶æ€§èƒ½é—®é¢˜å¦‚ä½•ä¼˜åŒ–ï¼Ÿ

**A:** ä¼˜åŒ–å»ºè®®ï¼š

1. å‡å°‘æ•°æ®åº“æŸ¥è¯¢
```javascript
// ä¸å¥½çš„åšæ³•
onURLAdd((e) => {
    const user = app.db.queryOne("SELECT * FROM users WHERE id = ?", [e.user.id]);
    const config = app.db.queryOne("SELECT * FROM user_preferences WHERE user_id = ?", [e.user.id]);
    const stats = app.db.queryOne("SELECT * FROM user_stats WHERE user_id = ?", [e.user.id]);
    // å¤„ç†é€»è¾‘...
    return e.next();
});

// ä¼˜åŒ–åçš„åšæ³•
onURLAdd((e) => {
    const userInfo = app.db.queryOne(`
        SELECT u.*, up.theme, up.notifications, us.urls_count
        FROM users u
        LEFT JOIN user_preferences up ON u.id = up.user_id
        LEFT JOIN user_stats us ON u.id = us.user_id
        WHERE u.id = ?
    `, [e.user.id]);
    // å¤„ç†é€»è¾‘...
    return e.next();
});
```

2. ä½¿ç”¨ç¼“å­˜
```javascript
const cache = new Map();

onURLAdd((e) => {
    const cacheKey = `user_${e.user.id}_config`;
    let config = cache.get(cacheKey);

    if (!config) {
        config = app.db.queryOne("SELECT * FROM user_config WHERE user_id = ?", [e.user.id]);
        cache.set(cacheKey, config);

        // 5åˆ†é’Ÿåæ¸…é™¤ç¼“å­˜
        setTimeout(() => cache.delete(cacheKey), 5 * 60 * 1000);
    }

    // ä½¿ç”¨config...
    return e.next();
});
```

3. å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
```javascript
onURLAdd((e) => {
    // å¿«é€Ÿå¤„ç†
    e.url.processed = true;

    // å¼‚æ­¥å¤„ç†è€—æ—¶æ“ä½œ
    setTimeout(() => {
        app.db.execute("UPDATE urls SET indexed = 1 WHERE id = ?", [e.url.id]);
    }, 0);

    return e.next();
});
```

### Q4: å¦‚ä½•å¤„ç†æ’ä»¶é—´é€šä¿¡ï¼Ÿ

**A:** ä½¿ç”¨äº‹ä»¶æ€»çº¿æˆ–æ•°æ®åº“ï¼š

1. äº‹ä»¶æ€»çº¿æ–¹å¼
```javascript
// æ’ä»¶Aï¼šå‘é€äº‹ä»¶
onURLAdd((e) => {
    app.triggerCustom("url_classified", {
        urlId: e.url.id,
        category: e.url.category,
        timestamp: new Date().toISOString()
    });
    return e.next();
});

// æ’ä»¶Bï¼šç›‘å¬äº‹ä»¶
onCustomEvent("url_classified", (e) => {
    console.log("URL classified:", e.data.urlId, "->", e.data.category);

    // å¤„ç†åˆ†ç±»åçš„é€»è¾‘
    if (e.data.category === "important") {
        // å‘é€é€šçŸ¥ç­‰
    }
    return e.next();
});
```

2. æ•°æ®åº“æ–¹å¼
```javascript
// æ’ä»¶Aï¼šå†™å…¥æ•°æ®
onURLAdd((e) => {
    app.db.execute(`
        INSERT INTO plugin_messages (sender, receiver, type, data, created_at)
        VALUES (?, ?, ?, ?, datetime('now'))
    `, ["url_analyzer", "notification_sender", "url_added", JSON.stringify({
        urlId: e.url.id,
        category: e.url.category
    })]);
    return e.next();
});

// æ’ä»¶Bï¼šè¯»å–æ•°æ®ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
cronAdd("process_messages", "*/5 * * * *", () => {
    const messages = app.db.query(`
        SELECT * FROM plugin_messages
        WHERE receiver = ? AND processed = 0
        ORDER BY created_at ASC
        LIMIT 10
    `, ["notification_sender"]);

    messages.forEach(msg => {
        const data = JSON.parse(msg.data);
        // å¤„ç†æ¶ˆæ¯

        // æ ‡è®°ä¸ºå·²å¤„ç†
        app.db.execute(`
            UPDATE plugin_messages SET processed = 1 WHERE id = ?
        `, [msg.id]);
    });
});
```

---

è¿™ä¸ªä½¿ç”¨æ–¹æ¡ˆæä¾›äº†URLDBæ’ä»¶ç³»ç»Ÿçš„å®Œæ•´ä½¿ç”¨æŒ‡å—ï¼Œä»åŸºç¡€é…ç½®åˆ°é«˜çº§åŠŸèƒ½ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹å¹¶å……åˆ†åˆ©ç”¨æ’ä»¶ç³»ç»Ÿçš„èƒ½åŠ›ã€‚