# 插件系统配置说明

## 📋 配置文件

已创建 `.env.example` 文件，包含完整的插件系统配置选项。

## 🔧 核心配置项

### 基础配置
```bash
# 是否启用插件系统
PLUGIN_ENABLED=true

# 是否启用热重载
PLUGIN_HOT_RELOAD=true

# 插件目录
PLUGIN_HOOKS_DIR=./hooks
PLUGIN_MIGRATIONS_DIR=./migrations
PLUGIN_TYPES_DIR=./pb_data
```

### 性能配置
```bash
# JavaScript虚拟机池大小
PLUGIN_VM_POOL_SIZE=10

# 最大内存使用（MB）
PLUGIN_MAX_MEMORY_MB=512

# 最大执行时间（秒）
PLUGIN_MAX_EXECUTION_TIME_SEC=30

# 最大并发任务数
PLUGIN_MAX_CONCURRENT_JOBS=5
```

### 安全配置
```bash
# 启用沙箱模式
PLUGIN_ENABLE_SANDBOX=true

# 允许的最大文件大小（MB）
PLUGIN_ALLOWED_FILE_SIZE_MB=10

# 是否允许网络访问
PLUGIN_ENABLE_NETWORK_ACCESS=false
```

### 日志配置
```bash
# 日志级别
PLUGIN_LOG_LEVEL=info

# 启用性能日志
PLUGIN_ENABLE_PERFORMANCE_LOGGING=false

# 日志保留天数
PLUGIN_LOG_RETENTION_DAYS=7
```

### 通知配置
```bash
# 邮件通知
PLUGIN_NOTIFICATION_EMAIL_ENABLED=false
PLUGIN_NOTIFICATION_EMAIL_SMTP_HOST=
PLUGIN_NOTIFICATION_EMAIL_SMTP_PORT=587

# Webhook通知
PLUGIN_WEBHOOK_ENABLED=false
PLUGIN_WEBHOOK_URL=
PLUGIN_WEBHOOK_SECRET=
```

### 定时任务配置
```bash
# 启用定时任务
PLUGIN_CRON_ENABLED=true

# 最大并发定时任务
PLUGIN_CRON_MAX_CONCURRENT_JOBS=3

# 定时任务时区
PLUGIN_CRON_TIMEZONE=Asia/Shanghai
```

### API配置
```bash
# 启用API限流
PLUGIN_API_RATE_LIMIT_ENABLED=true
PLUGIN_API_RATE_LIMIT_REQUESTS_PER_MINUTE=100

# 启用CORS
PLUGIN_API_CORS_ENABLED=true
PLUGIN_API_CORS_ALLOWED_ORIGINS=*
```

## 📁 目录结构

```
urldb/
├── .env.example              # 配置示例（新建）
├── hooks/                    # 插件钩子目录
│   ├── config_demo.pb.js     # 配置演示插件
│   ├── url_classifier.pb.js  # URL分类插件
│   ├── notification_center.pb.js # 通知中心插件
│   ├── analytics_engine.pb.js # 分析引擎插件
│   └── test_demo.pb.js       # 测试插件模板
├── migrations/               # 数据库迁移文件
├── pb_data/                  # 插件数据和类型定义
└── plugin*.go               # 插件系统核心代码
```

## 🚀 快速开始

### 1. 复制配置文件
```bash
cp .env.example .env
```

### 2. 编辑配置
```bash
# 编辑 .env 文件，设置插件配置
vim .env
```

### 3. 创建插件
```bash
# 创建钩子插件
./urldb plugin create my_plugin hook

# 创建迁移插件
./urldb plugin create my_migration migration
```

### 4. 验证插件
```bash
./urldb plugin validate hooks/my_plugin.pb.js
```

### 5. 查看插件状态
```bash
./urldb plugin stats
./urldb plugin list
```

## 📊 当前插件状态

```
=== 插件系统统计 ===
钩子文件数量: 8
迁移文件数量: 0
类型文件存在: true
最后更新时间: 2025-12-25 08:22:21
```

## 🎯 可用插件

| 插件名称 | 功能描述 | 状态 |
|---------|---------|------|
| config_demo.pb.js | 配置系统演示 | ✅ 已测试 |
| url_classifier.pb.js | URL智能分类 | ✅ 已验证 |
| notification_center.pb.js | 多渠道通知中心 | ✅ 已验证 |
| analytics_engine.pb.js | 数据分析引擎 | ✅ 已验证 |
| test_demo.pb.js | 测试插件模板 | ✅ 新创建 |

## 🔍 配置验证

插件系统会自动验证以下配置：

1. **目录存在性**：确保插件目录存在
2. **权限检查**：验证目录读写权限
3. **资源限制**：检查内存和执行时间限制
4. **安全设置**：验证沙箱和安全配置

## 📝 注意事项

1. **性能调优**：根据服务器性能调整 `PLUGIN_VM_POOL_SIZE`
2. **安全考虑**：生产环境建议启用 `PLUGIN_ENABLE_SANDBOX`
3. **日志管理**：定期清理过期日志文件
4. **监控告警**：建议配置通知和Webhook进行监控

## 🛠️ 故障排除

### 插件无法加载
- 检查 `PLUGIN_ENABLED=true`
- 验证插件目录权限
- 查看日志文件排查错误

### 性能问题
- 调整 `PLUGIN_VM_POOL_SIZE`
- 检查 `PLUGIN_MAX_MEMORY_MB`
- 启用 `PLUGIN_ENABLE_PERFORMANCE_LOGGING`

### 安全问题
- 确保 `PLUGIN_ENABLE_SANDBOX=true`
- 限制 `PLUGIN_ALLOWED_FILE_SIZE_MB`
- 禁用不必要的 `PLUGIN_ENABLE_NETWORK_ACCESS`

---

**配置文件**: `.env.example`
**更新时间**: 2024-12-25
**插件版本**: 1.0.0